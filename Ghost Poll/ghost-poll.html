<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Halloween Ghost Poll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --accent:#ff8c00; }
    body {
      font-family: Arial, sans-serif; background:#111; color:#fff;
      text-align:center; padding:40px 20px;
    }
    h1 { color: var(--accent); margin-top:0; }
    .buttons { margin: 10px 0 20px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    button {
      font-size: 1.1em; padding: 14px 22px; border: none; border-radius: 10px; cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,.3); touch-action: manipulation;
    }
    .yes { background: #2e8b57; color: #fff; }
    .no  { background: #b22222; color: #fff; }
    .panel {
      max-width: 560px; margin: 0 auto; background:#181818; border:2px solid #333; border-radius:16px; padding:18px;
    }
    table {
      margin: 16px auto; border-collapse: collapse; width: 100%; max-width: 440px; font-size: 1.1em;
    }
    th, td { border: 2px solid #fff; padding: 12px; }
    .footnote { color:#aaa; font-size:.9em; margin-top:10px; }

    /* Admin */
    .admin-bar { display:flex; gap:10px; justify-content:center; margin:14px 0 8px; flex-wrap:wrap; }
    .admin-btn { background:#444; color:#fff; }
    .danger   { background:#6b1a1a; color:#fff; }
    .safe     { background:#2e8b57; color:#fff; }
    .admin-locked-note { color:#bbb; font-size:.95em; margin-bottom:10px; }
    .admin-grid {
      margin-top: 12px; display:grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items:end;
      max-width: 440px; margin-left:auto; margin-right:auto;
    }
    .admin-grid label { text-align:left; font-weight:bold; }
    .admin-grid input {
      width: 100%; padding: 10px; font-size: 1.05em; border-radius: 8px; border:1px solid #666; background:#222; color:#fff;
    }
    .row-actions { display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <h1>üéÉ Do you believe in ghosts? üëª</h1>

  <div class="buttons">
    <button class="yes" onclick="vote('yes')">Yes üëª</button>
    <button class="no"  onclick="vote('no')">No üö´</button>
  </div>

  <div class="panel" id="panel">
    <table aria-label="Ghost poll results">
      <tr><th>Choice</th><th>Votes</th></tr>
      <tr><td>Yes</td><td id="yesCount">0</td></tr>
      <tr><td>No</td><td id="noCount">0</td></tr>
      <tr><td>Total</td><td id="totalCount">0</td></tr>
    </table>

    <!-- Admin toolbar (locked by PIN) -->
    <div class="admin-bar">
      <button class="admin-btn" id="adminLoginBtn" onclick="adminLogin()">Admin Login</button>
      <button class="admin-btn hidden" id="lockBtn" onclick="lockAdmin()">Lock</button>
      <button class="admin-btn hidden" id="changePinBtn" onclick="changePin()">Change PIN</button>
    </div>

    <div class="admin-locked-note" id="lockedNote">Admin controls are locked.</div>

    <!-- Admin controls (hidden until unlocked) -->
    <div id="adminArea" class="hidden">
      <div class="admin-grid">
        <label for="yesInput">Manual Yes total:</label>
        <input type="number" id="yesInput" min="0" value="0" inputmode="numeric" />
        <label for="noInput">Manual No total:</label>
        <input type="number" id="noInput" min="0" value="0" inputmode="numeric" />
      </div>
      <div class="row-actions">
        <button class="safe" onclick="manualOverride()">Set Totals</button>
        <button class="danger" onclick="clearVotes()">Clear All Votes</button>
      </div>
    </div>

    <div class="footnote" id="savedNote">Saved locally on this device.</div>
  </div>

  <script>
    // ------- Simple state -------
    const KEY = 'ghostPoll';
    const PIN_KEY = 'ghostPollPinHash'; // sha-256 of PIN
    let votes = load(KEY) || { yes: 0, no: 0, lastCleared: null };
    let adminUnlocked = false;

    // ------- Helpers -------
    function load(k) {
      try { return JSON.parse(localStorage.getItem(k)); } catch(e){ return null; }
    }
    function save(k, v) {
      localStorage.setItem(k, JSON.stringify(v));
    }
    function textHashSHA256(text) {
      const enc = new TextEncoder();
      return crypto.subtle.digest('SHA-256', enc.encode(text)).then(buf => {
        return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
      });
    }
    function promptForHidden(message) {
      // Simple prompt (digits recommended); allows cancel
      return prompt(message);
    }

    // ------- Display -------
    function updateDisplay() {
      document.getElementById('yesCount').textContent = votes.yes;
      document.getElementById('noCount').textContent  = votes.no;
      document.getElementById('totalCount').textContent = votes.yes + votes.no;
      document.getElementById('yesInput').value = votes.yes;
      document.getElementById('noInput').value  = votes.no;
      updateSavedNote();
    }
    function updateSavedNote() {
      const note = document.getElementById('savedNote');
      if (votes.lastCleared) {
        const d = new Date(votes.lastCleared);
        note.textContent = `Saved locally on this device. Last cleared: ${d.toLocaleString()}.`;
      } else {
        note.textContent = 'Saved locally on this device.';
      }
    }
    function flashBorder(color) {
      const panel = document.getElementById('panel');
      const prev = panel.style.borderColor;
      panel.style.borderColor = color;
      setTimeout(() => panel.style.borderColor = prev || '#333', 250);
    }

    // ------- Voting -------
    function vote(choice) {
      if (choice !== 'yes' && choice !== 'no') return;
      votes[choice]++;
      save(KEY, votes);
      updateDisplay();
    }

    function manualOverride() {
      const y = parseInt(document.getElementById('yesInput').value, 10);
      const n = parseInt(document.getElementById('noInput').value, 10);
      votes.yes = Number.isFinite(y) && y >= 0 ? y : 0;
      votes.no  = Number.isFinite(n) && n >= 0 ? n : 0;
      save(KEY, votes);
      updateDisplay();
      flashBorder('#2e8b57');
    }

    function clearVotes() {
      if (!adminUnlocked) return;
      const ok = confirm('‚ö†Ô∏è Clear ALL votes to zero? This cannot be undone.');
      if (!ok) return;
      votes.yes = 0;
      votes.no = 0;
      votes.lastCleared = new Date().toISOString();
      save(KEY, votes);
      updateDisplay();
      flashBorder('#b22222');
    }

    // ------- Admin lock/unlock & PIN -------
    function setAdminUI( unlocked ) {
      adminUnlocked = unlocked;
      document.getElementById('adminArea').classList.toggle('hidden', !unlocked);
      document.getElementById('lockedNote').classList.toggle('hidden', unlocked);
      document.getElementById('adminLoginBtn').classList.toggle('hidden', unlocked);
      document.getElementById('lockBtn').classList.toggle('hidden', !unlocked);
      document.getElementById('changePinBtn').classList.toggle('hidden', !unlocked);
    }

    async function adminLogin() {
      const existingHash = localStorage.getItem(PIN_KEY);

      if (!existingHash) {
        // First-time setup: create PIN
        const pin1 = promptForHidden('Create a new admin PIN (digits recommended):');
        if (pin1 === null || pin1 === '') return;
        const pin2 = promptForHidden('Confirm the new PIN:');
        if (pin2 === null) return;
        if (pin1 !== pin2) { alert('PINs do not match. Try again.'); return; }
        const hash = await textHashSHA256(pin1);
        localStorage.setItem(PIN_KEY, hash);
        alert('PIN set. Admin unlocked.');
        setAdminUI(true);
        return;
      }

      // Verify PIN
      const pin = promptForHidden('Enter admin PIN:');
      if (pin === null) return;
      const hash = await textHashSHA256(pin);
      if (hash === existingHash) {
        setAdminUI(true);
      } else {
        alert('Incorrect PIN.');
      }
    }

    function lockAdmin() {
      setAdminUI(false);
    }

    async function changePin() {
      if (!adminUnlocked) return;
      const currentHash = localStorage.getItem(PIN_KEY);
      const oldPin = promptForHidden('Enter current PIN:');
      if (oldPin === null) return;
      const oldHash = await textHashSHA256(oldPin);
      if (oldHash !== currentHash) { alert('Incorrect PIN.'); return; }

      const pin1 = promptForHidden('Enter new PIN:');
      if (pin1 === null || pin1 === '') return;
      const pin2 = promptForHidden('Confirm new PIN:');
      if (pin2 === null) return;
      if (pin1 !== pin2) { alert('PINs do not match.'); return; }
      const newHash = await textHashSHA256(pin1);
      localStorage.setItem(PIN_KEY, newHash);
      alert('PIN changed.');
    }

    // ------- Init -------
    updateDisplay();
    setAdminUI(false);
  </script>
</body>
</html>
